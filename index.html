<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZEP ì›ì†Œ ì¡°í•© ê²Œì„ â€” Quest & ë„ê°</title>
  <meta name="description" content="ì›ì†Œë¥¼ ì¡°í•©í•´ ì¼ìƒ ì† ë¬¼ì§ˆì„ ë§Œë“œëŠ” í€˜ìŠ¤íŠ¸í˜• ë¯¸ë‹ˆê²Œì„. ZEP ìœ„ì ¯/ê¹ƒí—ˆë¸Œ í˜ì´ì§€ í˜¸í™˜ ë‹¨ì¼ HTML." />
  <style>
    :root{
      --bg:#0f0a1f; --panel:#1a1240; --panel-2:#24145d; --accent:#9d7dff; --accent-2:#c9b8ff;
      --text:#f5f3ff; --muted:#bfb8d9; --ok:#31d0aa; --warn:#ffb020; --err:#ff5c8a;
      --shadow: 0 12px 28px rgba(0,0,0,.45), 0 2px 6px rgba(0,0,0,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; font-family: ui-rounded, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Apple SD Gothic Neo, sans-serif; color:var(--text);
      background: radial-gradient(1000px 600px at 80% -10%, #4b2cff44, transparent 60%),
                  radial-gradient(800px 500px at -10% 110%, #2e1a8a44, transparent 60%), var(--bg);
      display:grid; place-items:center;}
    .app{width:min(1200px, 96vw); height:min(820px, 96vh); display:grid; grid-template-rows:auto 1fr auto; gap:12px}
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; background:linear-gradient(180deg, #2a1a63 0%, #1b1240 100%);
      border:1px solid #3c2c84; border-radius:18px; padding:14px 18px; box-shadow:var(--shadow)}
    header .title{display:flex; align-items:center; gap:12px}
    .logo{width:40px;height:40px;border-radius:12px; background:conic-gradient(from 0deg, #c9b8ff, #9d7dff, #7c6cff, #c9b8ff); box-shadow:inset 0 0 0 2px #00000040}
    h1{font-size:18px; margin:0}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    button{appearance:none; border:none; cursor:pointer; color:var(--text); background:linear-gradient(180deg, var(--accent), #6c57f5);
      border-radius:12px; padding:10px 14px; font-weight:700; letter-spacing:.2px; box-shadow:var(--shadow); transition: transform .06s ease, filter .2s ease; white-space:nowrap}
    button.secondary{ background:linear-gradient(180deg, #34246f, #21174e); border:1px solid #4a3aa8; font-weight:600; color:var(--accent-2)}
    button.flat{ background:#ffffff10; border:1px solid #ffffff25; color:var(--muted); font-weight:600}
    button:active{ transform: translateY(1px) }
    .main{display:grid; grid-template-columns: 330px 1fr 330px; gap:12px}
    .panel{background:linear-gradient(180deg, var(--panel-2), var(--panel)); border:1px solid #3c2c84; border-radius:18px; padding:12px; box-shadow:var(--shadow)}
    .elements{ display:grid; grid-template-rows:auto 1fr; gap:10px }
    .search{ display:flex; gap:8px }
    .search input{ flex:1; padding:10px 12px; border-radius:12px; border:1px solid #3c2c84; background:#110b2a; color:var(--text) }
    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; overflow:auto; padding-right:3px }
    .card{ background:linear-gradient(180deg,#2b1a6b,#21144f); border:1px solid #4a3aa8; border-radius:14px; padding:10px; text-align:center; display:grid; gap:4px; place-items:center; user-select:none }
    .el-symbol{ font-size:22px; font-weight:900 }
    .el-name{ font-size:12px; color:var(--muted) }
    .card[draggable="true"]{ cursor:grab }
    .lab{ display:grid; grid-template-rows:auto auto 1fr auto; gap:10px }
    .statusbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
    .status{ display:flex; gap:10px; align-items:center; background:#120b2b; border:1px solid #3c2c84; padding:8px 10px; border-radius:12px}
    .pill{ padding:2px 8px; border-radius:999px; font-size:12px; background:#2a1a63; border:1px solid #6c57f5; color:#dcd4ff }
    .quest{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center; background:#140c33; border:1px solid #3c2c84; border-radius:12px; padding:10px }
    .quest .label{ font-weight:800 }
    .dropzone{ height:260px; border-radius:16px; border:2px dashed #6a56f5; background:#150d35; display:grid; place-items:center; position:relative; overflow:hidden }
    .cauldron{ width:220px; height:220px; border-radius:50%; background: radial-gradient(120px 80px at 50% 40%, #9d7dff22, transparent 60%), radial-gradient(70px 50px at 40% 30%, #ffffff08, transparent 60%), linear-gradient(180deg,#2a1a63,#140d33); border:2px solid #4a3aa8; display:grid; place-items:center; box-shadow: inset 0 10px 40px #00000080, 0 10px 30px #00000060 }
    .slots{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; gap:18px }
    .slot{ width:84px; height:84px; border-radius:14px; background:#0d0922; border:2px solid #4a3aa8; display:grid; place-items:center; font-weight:800 }
    .slot.filled{ background:#201453; border-color:#9d7dff }
    .hint{ font-size:12px; color:var(--muted); text-align:center }
    .lab-controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    .output{ min-height:46px; display:flex; align-items:center; justify-content:center; gap:8px; border-radius:12px; padding:8px 10px; background:#120b2b; border:1px solid #3c2c84; color:var(--accent-2) }
    .dex{ display:grid; grid-template-rows:auto auto 1fr; gap:10px }
    .dex-list{ display:grid; grid-template-columns: 1fr; gap:8px; overflow:auto; padding-right:3px }
    .found{ display:flex; align-items:center; gap:10px; background:#1b1243; border:1px solid #4a3aa8; border-radius:12px; padding:8px 10px }
    @media (max-width: 980px){ .main{ grid-template-columns: 1fr; grid-auto-rows:auto } }
    .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:16px; background:#110b2a; border:1px solid #3c2c84; color:var(--accent-2); padding:10px 14px; border-radius:12px; box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .25s ease }
    .toast.show{ opacity:1 }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>ZEP ì›ì†Œ ì¡°í•© ì‹¤í—˜ì‹¤</h1>
          <div style="font-size:12px;color:var(--muted)">ë‘ ì›ì†Œë¥¼ íˆ¬ì… â†’ <span style="color:var(--accent-2)">ì¡°í•©</span> ë²„íŠ¼! í€˜ìŠ¤íŠ¸ë¥¼ ì™„ë£Œí•˜ë©´ XPë¥¼ ì–»ì–´ìš”.</div>
        </div>
      </div>
      <div class="controls">
        <div class="status"><span class="pill" id="level-pill">Lv.1</span><span class="pill" id="xp-pill">0 XP</span></div>
        <button class="secondary" id="btn-share">í˜„ì¬ ë§í¬ ê³µìœ </button>
        <button class="flat" id="btn-reset">ì§„í–‰ ì´ˆê¸°í™”</button>
      </div>
    </header>

    <div class="main">
      <section class="panel elements" aria-label="ì›ì†Œ ëª©ë¡">
        <div class="search">
          <input id="q" placeholder="ì›ì†Œ ê²€ìƒ‰: H, ì‚°ì†Œ, copperâ€¦" />
          <button class="secondary" id="btn-shuffle">ì„ê¸°</button>
        </div>
        <div class="grid" id="element-grid" aria-live="polite"></div>
      </section>

      <section class="panel lab" aria-label="ì—°ê¸ˆ ì‹¤í—˜">
        <div class="statusbar">
          <div class="quest" id="quest">
            <div>
              <div class="label">í˜„ì¬ í€˜ìŠ¤íŠ¸</div>
              <div id="quest-text" style="font-size:13px;color:var(--accent-2)">[ì‹œì‘] ë²„íŠ¼ìœ¼ë¡œ í€˜ìŠ¤íŠ¸ë¥¼ ë°›ìœ¼ì„¸ìš”.</div>
            </div>
            <div style="display:flex; gap:8px">
              <button class="secondary" id="btn-new-quest">ì‹œì‘</button>
              <button class="flat" id="btn-skip-quest">ê±´ë„ˆë›°ê¸°</button>
            </div>
          </div>
        </div>

        <div class="dropzone" id="dropzone">
          <div class="cauldron" aria-hidden="true"></div>
          <div class="slots">
            <div class="slot" id="slotA" data-slot="A" aria-label="íˆ¬ì… ìŠ¬ë¡¯ A"></div>
            <div class="slot" id="slotB" data-slot="B" aria-label="íˆ¬ì… ìŠ¬ë¡¯ B"></div>
          </div>
        </div>
        <div class="lab-controls">
          <button id="btn-combine">ì¡°í•©í•˜ê¸°</button>
          <button class="secondary" id="btn-clear">ìŠ¬ë¡¯ ë¹„ìš°ê¸°</button>
          <div class="hint">íŒ: ì¹´ë“œë¥¼ ë“œë˜ê·¸í•´ ìŠ¬ë¡¯ì— ë†“ê±°ë‚˜, ì¹´ë“œë¥¼ ë‘ ë²ˆ í´ë¦­í•´ë„ íˆ¬ì…ë©ë‹ˆë‹¤.</div>
        </div>
        <div class="output" id="output" aria-live="polite">âœ¨ ìƒˆ ì¡°í•©ì„ ë°œê²¬í•´ë³´ì„¸ìš”!</div>
      </section>

      <aside class="panel dex" aria-label="ë°œê²¬ ë„ê°">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
          <div style="font-weight:800">ë°œê²¬ ë„ê°</div>
          <span class="pill" id="found-count">0 / 0</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px">
          <div class="pill" id="badge-count">ë°°ì§€ 0</div>
        </div>
        <div class="dex-list" id="dex"></div>
      </aside>
    </div>

    <footer style="text-align:center; font-size:12px; color:var(--muted)">Made for ZEP Â· GitHub Pages í˜¸í™˜ Â· ì €ì¥ì€ ë¸Œë¼ìš°ì € LocalStorage ì‚¬ìš©</footer>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    const ELEMENTS = [
      {sym:"H", name:"ìˆ˜ì†Œ", color:"#ffd166"},
      {sym:"O", name:"ì‚°ì†Œ", color:"#9bf6ff"},
      {sym:"C", name:"íƒ„ì†Œ", color:"#cfd1d6"},
      {sym:"S", name:"í™©", color:"#ffe066"},
      {sym:"Cl", name:"ì—¼ì†Œ", color:"#baffc9"},
      {sym:"Na", name:"ë‚˜íŠ¸ë¥¨", color:"#ffc6ff"},
      {sym:"Fe", name:"ì² ", color:"#d0d0d0"},
      {sym:"Mg", name:"ë§ˆê·¸ë„¤ìŠ˜", color:"#a0c4ff"},
      {sym:"Cu", name:"êµ¬ë¦¬", color:"#ffadad"},
      {sym:"Zn", name:"ì•„ì—°", color:"#bde0fe"},
      {sym:"Ca", name:"ì¹¼ìŠ˜", color:"#e6f4b8"},
      {sym:"Al", name:"ì•Œë£¨ë¯¸ëŠ„", color:"#d7e1f2"},
      {sym:"N", name:"ì§ˆì†Œ", color:"#cdeffd"},
    ];

    const RECIPES = {
      "Cu+O":  {name:"ì‚°í™”êµ¬ë¦¬",   formula:"CuO",   use:"ê°€ìŠ¤ ì„¼ì„œ, ë°˜ë„ì²´, ì´‰ë§¤",            cats:["ê¸ˆì† ì‚°í™”ë¬¼"]},
      "Cl+Cu":  {name:"ì—¼í™”êµ¬ë¦¬",   formula:"CuClâ‚‚", use:"ì •ìˆ˜ ê³µì •, ìˆ˜ì˜ì¥ ì†Œë…ì œ",            cats:["ì—¼ í™”í•©ë¬¼", "ì¼ìƒ"]},
      "Cu+S":  {name:"í™©í™”êµ¬ë¦¬",   formula:"CuS",   use:"íƒœì–‘ì „ì§€, ë°œê´‘í˜ì¸íŠ¸, ì „ê·¹, ìœ¤í™œìœ ", cats:["í™© í™”í•©ë¬¼"]},
      "H+O":   {name:"ë¬¼",        formula:"Hâ‚‚O",  use:"ë¬¼",                               cats:["ì¼ìƒ"]},
      "C+O":   {name:"ì´ì‚°í™”íƒ„ì†Œ", formula:"COâ‚‚",  use:"íƒ„ì‚°ìŒë£Œ, ì†Œí™”ê¸°, ë“œë¼ì´ì•„ì´ìŠ¤",     cats:["ê°€ìŠ¤"]},
      "Mg+O":  {name:"ì‚°í™”ë§ˆê·¸ë„¤ìŠ˜", formula:"MgO", use:"ì œì‚°ì œ, ì™„í•˜ì œ, ë¹„ë£Œ, ë‚´í™” ì¬ë£Œ",     cats:["ê¸ˆì† ì‚°í™”ë¬¼", "ì¼ìƒ"]},
      "Fe+O":  {name:"ì‚°í™”ì² ",     formula:"Feâ‚‚Oâ‚ƒ", use:"í˜ì¸íŠ¸ ìƒ‰ì†Œ(ì ê°ˆìƒ‰), ë„ë¡œ ìƒ‰ìƒ",      cats:["ê¸ˆì† ì‚°í™”ë¬¼", "ì¼ìƒ"]},
      "Cl+H":  {name:"ì—¼í™”ìˆ˜ì†Œ",   formula:"HCl",  use:"í™”í•™ì‚°ì—…, ì œì•½, ì‹ë£Œí’ˆ, ê°€ì£½ ì²˜ë¦¬", cats:["ì‚°ì„±"]},
      "H+S":   {name:"í™©í™”ìˆ˜ì†Œ",   formula:"Hâ‚‚S",  use:"í™©ì‚° ì œì¡° ì¤‘ê°„ë¬¼ì§ˆ (ë…ì„± ì£¼ì˜)",      cats:["í™© í™”í•©ë¬¼", "ê°€ìŠ¤"]},
      "Na+Cl": {name:"ì†Œê¸ˆ",      formula:"NaCl", use:"ì¡°ë¯¸ë£Œ, ì œì„¤ì œ",                   cats:["ì—¼ í™”í•©ë¬¼", "ì¼ìƒ"]},
      "C+H":   {name:"ë©”íƒ„",      formula:"CHâ‚„",  use:"ì²œì—°ê°€ìŠ¤ ì—°ë£Œ",                    cats:["ê°€ìŠ¤"]},
      "H+N":   {name:"ì•”ëª¨ë‹ˆì•„",   formula:"NHâ‚ƒ",  use:"ë¹„ë£Œ(í•˜ë²„-ë³´ìŠˆ), ì„¸ì •ì œ",             cats:["ê°€ìŠ¤", "ì¼ìƒ"]},
      "Al+O":  {name:"ì‚°í™”ì•Œë£¨ë¯¸ëŠ„", formula:"Alâ‚‚Oâ‚ƒ", use:"ì—°ë§ˆì¬, ë‚´ì—´ì¬",                 cats:["ê¸ˆì† ì‚°í™”ë¬¼"]},
      "Ca+C":  {name:"íƒ„ì‚°ì¹¼ìŠ˜",    formula:"CaCOâ‚ƒ", use:"ì„íšŒì„, ë¶„í•„, ì œì‚°ì œ",             cats:["ì¼ìƒ"]},
      "Cu+Zn": {name:"í™©ë™(ë¸Œë¼ìŠ¤)", formula:"Cuâ€“Zn í•©ê¸ˆ", use:"ì•…ê¸°, ì¥ì‹, ê¸°ê³„ë¶€í’ˆ",      cats:["í•©ê¸ˆ", "ì¼ìƒ"]},
    };

    const ALL_KEYS = Object.keys(RECIPES);

    const QUEST_POOL = ALL_KEYS.map(k=>({
      key:k,
      text:`ì¼ìƒ/ì‚°ì—…ì—ì„œ ì“°ì´ëŠ” <strong>${RECIPES[k].name}</strong> (${RECIPES[k].use.split(',')[0]} ë“±)ë¥¼ ë§Œë“¤ì–´ ì£¼ì„¸ìš”.`,
    }));

    const state = {
      slotA:null, slotB:null,
      found: new Set(JSON.parse(localStorage.getItem("zep-alchemy-found")||"[]")),
      xp: +(localStorage.getItem("zep-alchemy-xp")||0),
      badges: new Set(JSON.parse(localStorage.getItem("zep-alchemy-badges")||"[]")),
      quest: null,
    };
    const save = ()=>{
      localStorage.setItem("zep-alchemy-found", JSON.stringify([...state.found]));
      localStorage.setItem("zep-alchemy-xp", state.xp);
      localStorage.setItem("zep-alchemy-badges", JSON.stringify([...state.badges]));
    };

    const byId = id=>document.getElementById(id);
    const toast = (msg)=>{ const t=byId('toast'); t.innerHTML=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1600) };
    const recipeKey = (a,b)=>{ const k=[a,b].sort().join('+'); return ALL_KEYS.includes(k)? k : null; };
    const levelOf = xp => Math.floor(xp/100)+1;

    function renderStatus(){
      byId('level-pill').textContent = `Lv.${levelOf(state.xp)}`;
      byId('xp-pill').textContent = `${state.xp} XP`;
      byId('badge-count').textContent = `ë°°ì§€ ${state.badges.size}`;
    }
    function renderGrid(list=ELEMENTS){
      const grid = byId('element-grid'); grid.innerHTML='';
      list.forEach(el=> grid.appendChild(elCard(el)));
    }
    function elCard(el){
      const d = document.createElement('div'); d.className='card'; d.tabIndex=0; d.setAttribute('role','button'); d.setAttribute('aria-label', `${el.name} (${el.sym}) íˆ¬ì…`);
      d.draggable = true; d.style.background = `linear-gradient(180deg, ${tinyShade(el.color, -12)}, ${tinyShade(el.color, -28)})`; d.style.borderColor = tinyShade(el.color, -40);
      d.innerHTML = `<div class="el-symbol">${el.sym}</div><div class="el-name">${el.name}</div>`;
      d.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', el.sym); });
      d.addEventListener('dblclick', ()=> smartPut(el.sym));
      d.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ smartPut(el.sym); e.preventDefault(); }});
      return d;
    }
    function tinyShade(hex, diff){ const c=hex.replace('#',''); const num=parseInt(c,16); let r=(num>>16)&255, g=(num>>8)&255, b=num&255; const f=v=>Math.max(0, Math.min(255, v+diff)); r=f(r); g=f(g); b=f(b); return '#' + [r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }

    const q = byId('q');
    q.addEventListener('input', ()=>{ const v=q.value.trim().toLowerCase(); if(!v) return renderGrid(); renderGrid(ELEMENTS.filter(e=> e.sym.toLowerCase().includes(v) || e.name.toLowerCase().includes(v))); });
    byId('btn-shuffle').addEventListener('click', ()=>{ const arr=[...ELEMENTS]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } renderGrid(arr); });

    const slotA = byId('slotA'); const slotB=byId('slotB');
    ;[slotA, slotB, byId('dropzone')].forEach(zone=>{ zone.addEventListener('dragover', e=>e.preventDefault()); zone.addEventListener('drop', e=>{ e.preventDefault(); const sym=e.dataTransfer.getData('text/plain'); smartPut(sym); }); });

    function smartPut(sym){ if(!state.slotA){ setSlot('A', sym); return; } if(!state.slotB){ setSlot('B', sym); return; } setSlot('B', sym); }
    function setSlot(which, sym){ state['slot'+which]=sym; const el=which==='A'?slotA:slotB; el.classList.add('filled'); el.textContent=sym; byId('output').textContent=`${state.slotA||'?'} + ${state.slotB||'?'} â†’ ì¡°í•© ì¤€ë¹„`; }
    function clearSlots(){ state.slotA=state.slotB=null; slotA.classList.remove('filled'); slotB.classList.remove('filled'); slotA.textContent=''; slotB.textContent=''; byId('output').textContent='ìŠ¬ë¡¯ì„ ì±„ìš´ ë’¤ ì¡°í•©í•´ë³´ì„¸ìš”!'; }
    byId('btn-clear').addEventListener('click', clearSlots);

    document.getElementById('btn-combine').addEventListener('click', combine);
    function combine(){
      const {slotA:a, slotB:b} = state; if(!a || !b){ toast('ë‘ ìŠ¬ë¡¯ì„ ì±„ì›Œì£¼ì„¸ìš”.'); return; }
      const key = recipeKey(a,b);
      if(!key){ byId('output').innerHTML = `âŒ ì¡°í•© ì‹¤íŒ¨ Â· <span style="color:var(--muted)">${a} + ${b}</span> ëŠ”(ì€) ë“±ë¡ëœ ì¡°í•©ì´ ì—†ì–´ìš”.`; wiggle(byId('output')); return; }
      const res = RECIPES[key];
      const id = `${res.name} (${res.formula})`;
      const isNew = !state.found.has(id);
      state.found.add(id);
      let gained = isNew ? 40 : 15;

      if(state.quest && state.quest.key === key){
        gained += 60;
        toast(`ğŸ† í€˜ìŠ¤íŠ¸ ì™„ë£Œ! +${gained} XP`);
        state.quest = null;
        byId('quest-text').innerHTML = 'ì™„ë£Œ! [ì‹œì‘]ìœ¼ë¡œ ìƒˆ í€˜ìŠ¤íŠ¸ë¥¼ ë°›ìœ¼ì„¸ìš”.';
      }

      state.xp += gained;
      save();
      renderStatus();
      renderDex();
      byId('output').innerHTML = `${isNew? 'ğŸ‰ ìƒˆ ë°œê²¬!':'âœ… ì¡°í•© ì„±ê³µ'} Â· <strong>${res.name}</strong> <span class="pill">${res.formula}</span> Â· <span class="pill">${res.use}</span> <span class="pill">+${gained} XP</span>`;
      checkBadges(res);
      clearSlots();
    }

    function wiggle(el){ el.style.transform='translateY(-1px)'; setTimeout(()=>el.style.transform='translateY(0)', 120); }

    function renderDex(){
      const dex = byId('dex'); dex.innerHTML='';
      const arr = [...state.found].sort((a,b)=> a.localeCompare(b,'ko'));
      arr.forEach(item=>{
        const row=document.createElement('div'); row.className='found';
        const m=item.match(/^(.*) \((.*)\)$/).slice(1);
        const name=m[0], formula=m[1];
        const rec = Object.values(RECIPES).find(r=>`${r.name} (${r.formula})`===item);
        row.innerHTML = `<div style="font-weight:800">${name}</div><div class="pill">${formula}</div><div class="pill">${rec?.use||''}</div>`;
        dex.appendChild(row);
      });
      byId('found-count').textContent = `${state.found.size} / ${Object.keys(RECIPES).length}`;
    }

    function checkBadges(res){
      const categories = res.cats||[];
      categories.forEach(cat=>{
        const have = [...state.found].map(id=>{
          const r = Object.values(RECIPES).find(x=>`${x.name} (${x.formula})`===id);
          return r?.cats||[];
        }).flat();
        const countInCat = have.filter(c=>c===cat).length;
        if(countInCat>=3 && !state.badges.has(cat)){
          state.badges.add(cat); save(); renderStatus(); toast(`ğŸª™ ë°°ì§€ íšë“: ${cat}`);
        }
      });
    }

    const btnNewQuest = byId('btn-new-quest');
    const btnSkipQuest = byId('btn-skip-quest');
    btnNewQuest.addEventListener('click', ()=>{
      state.quest = QUEST_POOL[Math.floor(Math.random()*QUEST_POOL.length)];
      byId('quest-text').innerHTML = state.quest.text;
      toast('ìƒˆ í€˜ìŠ¤íŠ¸ ì‹œì‘!');
    });
    btnSkipQuest.addEventListener('click', ()=>{ state.quest=null; byId('quest-text').textContent='[ì‹œì‘] ë²„íŠ¼ìœ¼ë¡œ í€˜ìŠ¤íŠ¸ë¥¼ ë°›ìœ¼ì„¸ìš”.'; });

    byId('btn-share').addEventListener('click', ()=>{
      const params = new URLSearchParams();
      if(state.found.size){ params.set('found', btoa(encodeURIComponent(JSON.stringify([...state.found])))); }
      if(state.xp){ params.set('xp', String(state.xp)); }
      if(state.badges.size){ params.set('bg', btoa(encodeURIComponent(JSON.stringify([...state.badges])))); }
      const url = `${location.origin}${location.pathname}?${params.toString()}`;
      navigator.clipboard?.writeText(url);
      toast('í˜„ì¬ ì§„í–‰ ë§í¬ë¥¼ í´ë¦½ë³´ë“œì— ë³µì‚¬í–ˆì–´ìš”');
    });

    (function restoreFromQuery(){
      const p = new URLSearchParams(location.search);
      const f = p.get('found');
      if(f){ try{ JSON.parse(decodeURIComponent(atob(f))).forEach(x=> state.found.add(x)); }catch(e){} }
      const xp = +(p.get('xp')||0); if(xp) state.xp = xp;
      const bg = p.get('bg'); if(bg){ try{ JSON.parse(decodeURIComponent(atob(bg))).forEach(x=> state.badges.add(x)); }catch(e){} }
      save();
    })();

    renderGrid(); renderDex(); renderStatus();
    byId('btn-reset').addEventListener('click', ()=>{
      if(!confirm('ëª¨ë“  ì§„í–‰(ë„ê°, XP, ë°°ì§€)ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      state.found.clear(); state.xp=0; state.badges.clear(); state.quest=null; save(); renderDex(); renderStatus(); toast('ì´ˆê¸°í™” ì™„ë£Œ');
    });
  </script>
</body>
</html>
